# Optimized VictoriaMetrics Configuration for Docker Compose

victoriametrics:
  image: victoriametrics/victoria-metrics:v1.101.0
  command:
    # Storage Configuration
    - '-storageDataPath=/victoria-metrics-data'
    - '-retentionPeriod=12'  # 12 months retention
    
    # Performance Optimization
    - '-search.maxConcurrentRequests=16'  # Increased for better concurrency
    - '-search.maxQueueDuration=30s'
    - '-search.maxQueryDuration=300s'  # 5 minutes max query time
    - '-search.maxSamplesPerQuery=1e10'  # 10 billion samples max
    - '-search.latencyOffset=30s'
    - '-search.minStalenessInterval=0'
    - '-search.maxPointsPerTimeseries=1e6'
    
    # Memory Management
    - '-memory.allowedPercent=80'  # Use up to 80% of available memory
    - '-search.maxMemoryPerQuery=2GB'
    - '-search.cacheDataPath=/cache'
    
    # Deduplication
    - '-dedup.minScrapeInterval=30s'
    - '-downsampling.period=30d:5m,90d:15m,365d:1h'  # Downsampling rules
    
    # HTTP Configuration
    - '-httpListenAddr=:8428'
    - '-http.maxGracefulShutdownDuration=30s'
    - '-http.shutdownDelay=0s'
    - '-http.idleConnTimeout=1m'
    - '-http.connTimeout=2m'
    
    # Logging
    - '-loggerLevel=INFO'
    - '-loggerFormat=json'
    - '-loggerOutput=stderr'
    
    # Snapshot Configuration
    - '-snapshot.createURL=http://localhost:8428/snapshot/create'
    - '-snapshot.deleteURL=http://localhost:8428/snapshot/delete'
    - '-snapshot.listURL=http://localhost:8428/snapshot/list'
    
    # Insert Configuration
    - '-maxInsertRequestSize=32MB'
    - '-maxLabelValueLen=4096'
    - '-maxLabelsPerTimeseries=64'
    
    # Storage Optimization
    - '-bigMergeConcurrency=4'  # Parallel merge operations
    - '-smallMergeConcurrency=8'
    - '-retentionTimezoneOffset=0h'
    
    # Monitoring
    - '-selfScrapeInterval=30s'
    - '-promscrape.suppressScrapeErrors'
    
  volumes:
    - victoriametrics_data:/victoria-metrics-data
    - victoriametrics_cache:/cache
    - victoriametrics_snapshots:/snapshots
    
  networks:
    - docaiche
    
  deploy:
    resources:
      limits:
        cpus: '4'
        memory: 8G
      reservations:
        cpus: '2'
        memory: 4G
        
  environment:
    # Performance tuning via environment variables
    GOGC: "50"  # More aggressive garbage collection
    GOMEMLIMIT: "7GiB"  # Set memory limit
    
  healthcheck:
    test: ["CMD", "wget", "-q", "--spider", "http://localhost:8428/health"]
    interval: 30s
    timeout: 10s
    retries: 5
    start_period: 30s
    
  restart: unless-stopped
  
  labels:
    - "docaiche.service=victoriametrics"
    - "docaiche.monitoring=true"
    - "traefik.enable=true"
    - "traefik.http.routers.victoriametrics.rule=PathPrefix(`/victoriametrics`)"
    - "traefik.http.routers.victoriametrics.priority=99"
    - "traefik.http.services.victoriametrics.loadbalancer.server.port=8428"
    - "traefik.http.middlewares.vm-stripprefix.stripprefix.prefixes=/victoriametrics"
    - "traefik.http.routers.victoriametrics.middlewares=vm-stripprefix"

# Additional volume definitions
volumes:
  victoriametrics_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /data/victoriametrics/data  # Use fast SSD storage
  victoriametrics_cache:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /data/victoriametrics/cache  # Use fast SSD storage
  victoriametrics_snapshots:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /data/victoriametrics/snapshots  # Can use slower storage